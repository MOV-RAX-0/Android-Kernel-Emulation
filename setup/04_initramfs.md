# 04 – Initramfs: Shell Access and Debugging
This document outlines the design and structure of the `initramfs` used in this Android kernel emulation lab. 
It covers how the initramfs is built, what tools are included, and how to interact with it via shell once the emulated system boots.


## 1. Purpose

The initramfs is the root filesystem loaded directly into memory at boot. It provides a minimal, self-contained environment for debugging and testing Android kernel behavior.\

**Goals:**
- Include essential shell tools (BusyBox)
- Add debugging utilities (e.g. gdbserver, pagemap, etc.)
- Provide shell access via serial console
- Support mounting host-shared folders via virtio-9p

## 2. Directory Structure

Typical layout after unpacking the `rootfs.cpio.gz`:

```
/
├── bin/
├── dev/
├── etc/
├── init
├── lib/
├── proc/
├── root/
├── sbin/
├── sys/
├── tmp/
└── usr/
```
This layout is generated by Buildroot or manually structured when assembling a custom initramfs.

## 3. The /init Script

This is the entry point executed by the kernel. A typical implementation includes:

```
#!/bin/sh
mount -t proc none /proc
mount -t sysfs none /sys
mount -t devtmpfs none /dev
mount -t tmpfs tmpfs /tmp

mkdir -p /mnt/hostshare
mount -t 9p -o trans=virtio hostshare /mnt/hostshare

echo "[*] Initramfs booted successfully"
exec /bin/sh
```

This ensures the virtual system is operational and can interact with the host.

## 4. Shell Behavior

- **Shell:** `/bin/sh` provided by BusyBox

- **Access:** Serial console (`-serial mon:stdio` via QEMU)

- **Utilities:** Minimal command set with BusyBox core utils

- **Debug Tools:** If included, tools like `gdbserver`, `readelf`, `hexdump`, and `pagemap` are available for low-level inspection

**Examples:**

```
ls /bin
cat /proc/cpuinfo
dmesg | grep 9p
/mnt/hostshare/validate-initramfs.sh
```

## 5. Included Debug Tools

The following statically-linked binaries are included in the initramfs:

- `/bin/sh` and core BusyBox utilities

- `gdbserver` for remote debugging

- `pagemap` and `/proc/self/pagemap` access tools

- `readelf`, `objdump`, `hexdump` for ELF inspection
- 
Each binary is verified for static linking using:
```
readelf -h ./usr/bin/toolname | grep "Type:"
```

Expect `EXEC (Executable file)` and no dynamic section entries.
